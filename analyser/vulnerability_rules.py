"""
Vulnerability Rules Engine
Defines detection logic for real security findings
"""

from typing import Dict, List, Any


class VulnerabilityRules:

    @staticmethod
    def check_server_error(result: Dict) -> List[Dict]:
        findings = []

        if result.get("status_code") == 500:
            findings.append({
                "type": "Server Crash",
                "severity": "HIGH",
                "reason": "Payload caused internal server error"
            })

        return findings


    @staticmethod
    def check_sql_injection(result: Dict) -> List[Dict]:
        findings = []
        body = result.get("response_body", "").lower()

        sql_patterns = [
            "sql syntax",
            "mysql",
            "sqlite",
            "syntax error",
            "database error"
        ]

        if any(p in body for p in sql_patterns):
            findings.append({
                "type": "SQL Injection",
                "severity": "CRITICAL",
                "reason": "Database error leaked in response"
            })

        return findings


    @staticmethod
    def check_info_disclosure(result: Dict) -> List[Dict]:
        findings = []
        headers = result.get("response_headers", {})

        dangerous = ["server", "x-powered-by"]

        for h in dangerous:
            if h in [k.lower() for k in headers.keys()]:
                findings.append({
                    "type": "Information Disclosure",
                    "severity": "LOW",
                    "reason": f"Sensitive header exposed: {h}"
                })

        return findings


    @staticmethod
    def check_timing_attack(result: Dict) -> List[Dict]:
        findings = []

        if result.get("response_time", 0) > 5:
            findings.append({
                "type": "Timing Anomaly",
                "severity": "MEDIUM",
                "reason": "Possible time-based injection"
            })

        return findings


    @staticmethod
    def run_all(result: Dict) -> List[Dict]:
        all_findings = []

        checks = [
            VulnerabilityRules.check_server_error,
            VulnerabilityRules.check_sql_injection,
            VulnerabilityRules.check_info_disclosure,
            VulnerabilityRules.check_timing_attack,
        ]

        for check in checks:
            all_findings.extend(check(result))

        return all_findings
